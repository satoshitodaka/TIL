# 第７章
- 可読性が高いコードを書くためには、コードレビューが必要
- コードレビューを効率的に行うためには、レビューイとレビューアがそれぞれ注意するポイントがある。
## 7-1
- レビューしやすいPRのために
  - 目的が明確であること
  - PRの規模が大きすぎないこと
  - 含まれるコミットが構造的であること
### 7-1-1
- 目的を明確にすることで、必要な修正・変更の理由が明らかになり、レビューしやすくなる。
- 明確にしておいた方が良いこと
  - PRの主な目的
  現在のPRでは対応しないこと
  - 今後のPRの計画
### 7-1-2
- PRの規模は、1日の作業量をもとに考えるとわかりやすい。一つの目安は、1日に3つをこなせる程度？（弊社の場合）
- 1週間・1ヶ月かけて傑作を作ってしまうと、差分が大きいためレビューしづらく、修正の手戻りも大きくなってしまう。
#### 大きな機能の開発
- 実装する機能の規模が大きい場合、単一の機能であってもPRを分割した方が良い。
- 機能が未完成の状態でマージするが、ビルドが可能な状態を維持する必要がある。（CIを通したり、他の機能を阻害しないため）
#### トップダウン方式
- 最初にスケルトンクラスだけを作り、メソッドなどの詳細は後から実装する手法
- シンプルな骨組みを作ることで、全体的な依存関係をレビューすることができる。
- 書き直しが必要となっても、手戻りは最小限にとどめることができる。
#### ボトムアップ方式
- 小さな部品を先に作り、それを使うコードを後から作る手法。
- 他のコードへの依存が限定的かつ、他のコードからの依存先になるコードの場合、適している。
- メリット
  - 各部品の独立性が高いため、構造的な欠陥があった場合でも再利用しやすい
  - また、並行して他のPRを対応しやすい。
- デメリット
  - 最終的な目的がわかりづらい
  - YAGNIの原則に反していないか、確認する必要がある。
- どちらか一方だけを使うのではなく、適宜適切な手法をとりながら進めることが大切。
#### 追加の作業が発生した場合
- PRを対応中に、当初の想定より追加の作業が発生することがある。（リファクタなど）
- アンチパターン
  - 同じPRで対応する。=> PRの目的がぶれて、レビューの精度が落ちる。
  - 時系列でPRを分割する。=> 一時的に技術的負債を抱えることになる。
- 正しい分割の案
  - 先に追加作業を完了させる。
  - コミットを分割・並び替えをしてマージする。commitを並び替えて開発ブランチを切り出すことで、別PRとして対応できる。
### 7-1-3
- 各コミットの責務を明確にし、不要なコミットが含まれないようにする必要がある。
- 不要なコードが含まれてしまった場合、削除用のコミットを作るのは良くない。git rebaseでコミットを編集し、コミット自体を削除すると良い。
- 一つのコミットで複数の変更を行うと、コミットの責務が曖昧になり、レビューが難しくなる。
  - アンチパターン（混ぜるな危険）
    - 一つのセクションの実装と、関連が薄いコードのリファクタリング
    - 名前やフォーマットの（表面的な）修正と、ロジックの修正
    - 自動生成のコードと手で書いたコード
- コミットの分割には軸を持たせる必要がある。手当たり次第に分割するのは良くない。
  - 例として、複数の機能とそのテストを書く必要がある場合。
  - 一つの機能について、実装とテストを一つのコミットにまとめることで、レビューしやすくなる。
  - 実装ごと・テストごとにコミットを分割すると、コミットの見比べが発生するので、レビューしづらい。
## 7-2
- レビューのコメントは可読性や正確性を上げるためのヒントであり、そのまま適用するのは良くない。
- 必要なこと
  - コメントや質問が発生した意図を考える。
  - コメントの意図を理解する。
  - 提案が他のコードに適用できないか考える。
### 7-2-1
- コメントは必ずしも正確なものとは限らない。
- コメントや質問があった場合はそれに愚直に答えるのではなく、コメントや質問が発生した意図を考慮する必要がある。一人が質問したコードは、他の開発者も疑問を持つ可能性があり、そもそも可読性が低かったり、ロジックが適切でない可能性がある。
- 考えられる対応
  - 疑問や誤解の余地をなくせるよう、コードを修正する。
  - コード内の解説で、疑問や誤解の解消を図る
### 7-2-2
- 提案された内容をそのまま適用するのは良くない。提案によって改善されることをきちんと理解すること。
  - シンプルにコード規約やバグが解消されるケース。
  - 改善点のみ着目し、他が簡略化されているケース（適用には工夫を要する？）
  - 提案されたコードがバグを含むケース
### 7-2-3
- 指摘されたコメントが適切である場合、他の場所に適用できないか確認すること。
- 可能であれば、一度指摘された内容は、以降のPRできちんと改善できることが望ましい。
## 7-3
- レビュー内容はコードや仕様、プロセスに言及する必要があり、暴言や人格否定があってはならない。
### 7-3-1
- レビュー依頼は放置してはいけない。営業日で24H以内に何らかの返信ができるのが望ましい。
- 優先度の都合でレビューが難しい場合、安請け負ってはいけない。レビューイの取れる選択肢を狭めてしまう。
### 7-3-2
- 問題のあるPRをブロックする必要がある。
- PRが大きすぎる場合、分割してもらう。（分割についてはフォローの必要がある）
- 設計に問題があれば、スケルトンクラスを作る、など。
### 7-3-3
- 締切を優先するあまり、品質が低いコードをマージするのは避けるべき。
- どうしても締切やスピードを優先する必要がある場合の対応
  - コードの修正について、大まかな方針の合意をとる。
  - その場しのぎのコードに対し、コメントとテストを用意する。
  - その場しのぎのコードの修正のIssueを作っておく。
### 7-3-4
- コメントは具体的であることが望ましいが、詳細を詰めすぎると、レビューの工数がかかってしまうため、バランスを考慮する必要がある。
- 教育的な観点から、あえて選択の幅を持たせることも意義がある。
- 無理に解読するより、レビューイに質問した方が良いこともある（他のレビューアも疑問に思うはず）
- 必ずしもGithubだけで行う必要はなく、適宜適切なコミュニケーションを取るのが望ましいが、PRにはコメントを残すこと。
