# 質問の一覧ページの実装
## 一覧を表示するページ
- 受け取った質問を確認するページのURLは`questions/received`とする。
- ファイルのパスは`pages/questions/received.tsx`とする。
## 質問の型を作成
- 質問のデータを利用するために `models/Question.ts`で型を宣言する。
```tsx
import { Timestamp } from 'firebase/firestore'

export interface Question {
  id: string
  senderUid: string
  receiverUid: string
  body: string
  isReplied: boolean
  createdAt: Timestamp
}
```
## ステートの宣言
- 取得した質問一覧を保持するためのステートを用意する。
```tsx
import { useState } from 'react'
import { Question } from '../../models/Question'
import Layout from '../../components/Layout'

export default function QuestionsReceived() {
  // ステートは配列とし、デフォルト値は空にしておく
  const [questions, setQuestions] = useState<Question[]>([])

  return (
    <Layout>
      // とりあえず、わかりやすいようにするため
      <div>{questions.length}</div>
    </Layout>
  )
}
```
## 質問一覧を取得
- 
```tsx
import { useEffect, useState } from 'react' // useEffectを追加
import {
  collection,
  getDocs,
  getFirestore,
  query,
  where,
} from 'firebase/firestore'
import { useAuthentication } from '../../hooks/authentication'

// 省略

export default function QuestionsReceived() {
  const [questions, setQuestions] = useState<Question[]>([])
  // currentUser でユーザー情報を取得するとエラーが発生する場合があるため、認証情報より取得する。
  const { user } = useAuthentication()

  useEffect(() => {
    // サーバーサイドの処理であれば中断する。
    if (!process.browser) {
      return
    }
    // ユーザーの認証情報がなければ中断する
    if (user === null) {
      return
    }

    async function loadQuestions() {
      const db = getFirestore()
      // 検索条件となる定数qを宣言し、コレクションのquestionsの中からuser.idがレシーバーと一致する条件を代入する
      const q = query(
        collection(db, 'questions'),
        where('receiverUid', '==', user.uid)
      )
      // 検索結果は複数データとなるため、snapshotの取得となる。
      const snapshot = await getDocs(q)

      // snapshot がemptyであれば処理を中断する。
      if (snapshot.empty) {
        return
      }

      // 定数gotQuestionsを宣言し、snapshotに格納されたドキュメントをquestionに格納する。
      // これにより、一覧gotQuestionsに含まれるドキュメントquestionを扱うことができる。
      const gotQuestions = snapshot.docs.map((doc) => {
        const question = doc.data() as Question
        question.id = doc.id
        return question
      })
      // gotQuestionsをquestionsにセットする。関数の中だけでなくページ全体で使用するため？
      setQuestions(gotQuestions)
    }

    loadQuestions()
  
  }, [process.browser, user])

  return (
    <Layout>
      // とりあえず、わかりやすいようにするため
      <div>{questions.length}</div>
    </Layout>
  )
}

```
> [Array.prototype.map() - MDN web doc](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Array/map)
## 一覧を表示する
- 一覧はBootstrapのCardを使って表示する。
```tsx
<Layout>
  <h1 className="h4">受け取った質問一覧</h1>

  <div className="row justify-content-center">
    <div className="col-12 col-md-6">
      {questions.map((question) => (
        <div className="card my-3" key={question.id}>
          <div className="card-body">
            <div className="text-truncate">{question.body}</div>
          </div>
        </div>
      ))}
    </div>
  </div>
</Layout>
```
### 投稿日時を表示する
- 投稿日時を人間が読みやすい形で表示させるため、dayjsというライブラリを導入する。
```
$ yarn add dayjs
```
- `pages/_app.tsx`に初期設定を記述する。
```tsx
// ライブラリのインポート
import dayjs from 'dayjs'
// 場所の情報をインポート
import 'dayjs/locale/ja'

// 使用する地域を日本に指定
dayjs.locale('ja')
```
- `pages/questions/received.tsx`に記述する
```tsx
import dayjs from 'dayjs'

// 省略

// 日時を表示する箇所に追記
<div className="text-muted text-end">
  <small>{dayjs(question.createdAt.toDate()).format('YYYY/MM/DD HH:mm')}</small>
</div>
```
> [TypeScript - DayJS](https://day.js.org/docs/en/installation/typescript)
## 並び順を変更する
- 並び替え自体はorderByで取得するので、Firestoreからインポートする。
```tsx
import {
  collection,
  getDocs,
  getFirestore,
  orderBy, // 追加
  query,
  where,
} from 'firebase/firestore'
```
- 検索条件に`createdAt`にたいし、`desc``を使って降順を指定する。
```tsx
const db = getFirestore()
const q = query(
  collection(db, 'questions'),
  where('receiverUid', '==', user.uid),
  orderBy('createdAt', 'desc') // 追記
)
const snapshot = getDocs(q)
```
- ただし、上記の設定だけだとエラーが発生するので、firebaseのエラー文に従ってインデックスを作成する。
## 無限スクロールを実装する
- 毎回全てのデータを取得するとコストがかかってしまうため、指定した件数のデータを取得するようにし、ページの下部に到達したら続きのデータを取得、無限にスクロールできるようにする。
- `pages/questions/received.tsx`に記述し、Firestoreからインポートする。
```tsx
import {
  collection,
  DocumentData, // 追加
  getDocs,
  getFirestore,
  limit, // 追加 取得するドキュメントの件数を制限する。
  orderBy,
  query,
  QuerySnapshot, // 追加
  startAfter, // 追加 クエリの開始点を指定する。（startAfterは開始点が除外される）
  where,
} from 'firebase/firestore'
```
> [Cloud Firestore でデータを並べ替えたり制限する - Firebase](https://firebase.google.com/docs/firestore/query-data/order-limit-data?hl=ja)
> [クエリカーソルを使用したデータのページ設定 - Firebase](https://firebase.google.com/docs/firestore/query-data/query-cursors?hl=ja)

- 取得するロジックを以下の通り書き換える。
  - クエリを作っている部分をcreateBaseQueryとして切り出す（共通化する）
```tsx
function createBaseQuery() {
  const db = getFirestore()
  return query(
    collection(db, 'questions'),
    where('receiverUid', '==', user.uid),
    orderBy('createdAt', 'desc'),
    limit(10)
  )
}

function appendQuestions(snapshot: QuerySnapshot<DocumentData>) {
  const gotQuestions = snapshot.docs.map((doc) => {
    const question = doc.data() as Question
    question.id = doc.id
    return question
  })
  setQuestions(questions.concat(gotQuestions))
}

async function loadQuestions() {
  const snapshot = await getDocs(createBaseQuery())

  if (snapshot.empty) {
    return
  }

  appendQuestions(snapshot)
}

async function loadNextQuestions() {
  if (questions.length === 0) {
    return
  }

  const lastQuestion = questions[questions.length - 1]
  const snapshot = await getDocs(
    query(createBaseQuery(), startAfter(lastQuestion.createdAt))
  )

  if (snapshot.empty) {
    return
  }

  appendQuestions(snapshot)
}

useEffect(() => {
  if (!process.browser) {
    return
  }
  if (user === null) {
    return
  }

  loadQuestions()
}, [process.browser, user])
```