# 3章
## 3-2
- Rackとは、アプリケーションフレームワークとアプリケーション・サーバーのインターフェースを共通化する仕様・ライブラリのこと。
- アプリケーションとサーバーの中間層により、疎結合的なやり取りが行えるようになった。これにより、フレームワークとサーバーの組み合わせと変更が容易となり、適切な選択がしやすくなった。
### 3-2-2
- Rackに必要なインターフェース
  - メソッドcallを定義する。
  - callメソッドは、慣例的にenvまたはenvironmentの引数を一つ受け取る。
  - callメソッドは以下の配列をレスポンスする。
   - statusの数値
   - headerのHash
   - bodyとなるArray
### 3-2-3
- Rackを使うことで、サーバーとアプリケーションの間に処理を追加できる。
### 3-2-4
- initializeメソッドで引数を受け取る
  - ここで処理するオブジェクトを受け取る。
- callメソッドを作ってRackアプリケーションと同じインターフェースを用意する。
  - middlewareのcallメソッドが呼ばれた際に、オブジェクトのcallメソッドを呼ぶことで、後続の処理を行えるようになる。
### 3-2-6
- config/environmentのファイルで指定することで、作成したmiddlewareを使用することができる。
- 作成したmiddlewareは、デフォルトではアプリケーションの実行直前に読み込まれるが、実行の順番は任意に指定できる。

## 3-3
### 3-3-3
- db:migrateをした時にschema.rbが生成される。これは、マイグレーションファイルではなく、DBに定義されている内容を定義するもの。
  - db:setupでは、マイグレーションファイルではなく、schema.rbにかかれていることをもとにテーブル構成を反映する。
- schema.rbを明示的に生成するためには、db:schema:dump 読み込む際には、db:schema:loadを使う。
### 3-3-4
- seedを生成する場合は、エラー発生時に気付けるようにcreate!メソッドを使うとよい。
### 3-3-5
- db:prepareを使うと、DBが存在する場合はマイグレーションを、存在しない場合はsetupを行う。
### 3-3-6
- 規模が大きいアプリケーションで、応答速度が遅くなるという問題があるため、Rails6からは複数DBに対応している。
  - それ以前は、Octopusやswitch_pointなどのgemで対応していた。
- 複数DB対応とは
  - 複数のprimaryDBと、それに対応する一つのreplica
  - モデルでのコネクションの自動切り替え
  - HTTPverb(HTTPの各種メソッド)や直近の書き込みに応じてprimaryとreplicaの自動スワップ（同期のようなイメージ）
  - 複数DBの作成・削除・マイグレーションなどを行うRailsタスク
- 各モデルにて、establish_connectionを使うと、subデータベースに接続できるようになるが、役割を明確にするため、establish_connectionを指定したクラスを作成し、それを継承させてモデルクラスを作成するのが良い。
#### 書き込みと読み込みの分離
- 複数DBの利用として最も多いのは、読み込みと書き込みのDBを分離する手法。
  - 書き込みDBをprymary、読み込みDBをreplicaとする。
  - database.ymlにて設定することで、replicaに書き込もうとすると、ActiveRecord::ReadOnlyErrorが発生する。
- 書き込みや読み込みのDBの明示は、connect_toを使ってロールとDBを指定する。モデル単位で指定してもよいが、DB接続のコネクション増加を避けるため、ApplicationRecordクラスに指定することで、テーブル全体に設定することができる。
  - ロールはwritingとreadingの2つがある。任意の名称を指定することもできる。
```rb
class ApplicationRecord < ActiveRecord::Base
 self.abstract_class = true
 connects_to database: {
  writing: :primary,
  reading: :primary_replica
 }
```
- 特定のクエリを発行する際に参照するDBを指定することもできる。connects_toにロールを指定したブロックを使う。
- primaryDBの更新を行った直後のデータの参照について、`delay: 2.seconds`とすることで、レプリカDBへの同期にかかる時間を猶予する。

## 3-4
## 3-5
### 3-5-2
#### CSPとは
- Content Security Policyのこと。HTMLタグの中で任意のスクリプトタグを実行できるようになると、悪意あるコードが実行されてしまうので、回避する必要がある。
- CSPを有効にするためには、サーバーからのレスポンスにContent Security Policyヘッダーを含める必要がある。
- これは、サーバーが送った同一オリジンから送信されたスクリプトしか実行させない、ということ。
#### RailsのCSP
- レスポンスのヘッダーに含めるだけなので、原理的にはどのバージョンでも使えるが、Rails5.2以降で設定が自動生成されるようになった。
- config/initializers/content_security_policy.rbではプロジェクト全体の設定を記述するが、コントローラで個別に指定することもできる。
- GAなどを利用する際、許可リストに追加スべき内容を漏らすことがある。これを回避するため、report onlyモードを設定することができる。違反を検知した場合、指定のURLにJSON形式で送信する。
#### nonce
- CSPにはnonceという機能がある。
  - 本来Javascriptのインラインでの実行は禁止するべきだが、要件を満たすために実行する必要がある場合もある。
  - CSPのnonceを使うと、指定したJavascriptのみを実行させることができる。
- nonceを使うためには、設定ファイルへの記述と、スクリプトタグにnonce属性を追加することが必要となる。
