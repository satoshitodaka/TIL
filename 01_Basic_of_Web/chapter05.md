# 5. Webアプリケーションの基本

## 01 Webアプリケーションの3層構造
ネットワークを介してブラウザ上で動作するアプリケーションをWebアプリケーションという。<br>
Webアプリケーシテーション層」、処理を行う「アプリケーション層」、データ保存や処理を行う「データ層」<br>
プレゼンテーション層はWebブラウザとWebサーバー<br>
アプリケーション層はAPサーバー、データ層はDBサーバーがになう。

- 負荷分散<br>
3層のサーバーを単一の機器で実行することは可能だが、規模の拡大、処理の複雑化により負荷が大きくなるため<br>
各層でサーバーを分ける事が多い。

- 改修範囲の限定<br>
アプリの改修は、層が分かれていると改修が他の層に影響しないため、改修コストが下がる。

## 02 MVCモデル
アプリケーションの構造に関し、MVCモデルという考え方がある。<br>
Modelでアプリで扱うデータを処理、Viewはユーザーへ出力する、Controllerは必要な処理をModelやView伝える、という役割がある。

- 3層アーキテクチャーとの違い<br>
3層アーキテクチャーとMVCモデルはそもそも概念が違う。<br>
MVCモデルは、3層アーキテクチャーのアプリケーションとデータ層に該当する。

- MVCモデルの利点<br>
開発や改修の分業が容易になる事。<br>
各要素が分離しているため、特定の要素の開発が他のモデルに影響を及ぼさないため、個別に開発を行う事ができる。

## 03 フレームワーク
Webアプリケーションの開発をゼロから立ち上げることは大変な手間がかかるが<br>
多くのアプリケーションの根本的な構造、一連のデータ処理は似通っているため、フレームワークと呼ばれる雛形を使用することで<br>
開発時間の短縮、品質の安定などを実現する事ができる。

- いろいろなフレームワーク<br>
Cake PHPやRuby on Railsなど

## 04 Webサーバー
Webサーバーはアプリケーションの動作において、クライアントに対する窓口の役割を果たす。<br>
1台のみの運用であれば、不具合の対応ができない（通知すらできない）ので、複数台の機器で運用する「冗長化」という構成にするのが一般的

- 求められるサーバー機器の性能<br>
静的リクエストが多いサイトの場合、HDDの読み取り速度やメモリの容量が多い事が求められる。<br>
動的リクエストが多いサイトの場合、CPUの性能が高い事が求められる。

- 静的コンテンツの配置<br>
Webサーバーに保管する静的コンテンツは、必ずしも同一のサーバーに保管する必要はなく、別のサーバーに保管することは可能。<br>
その場合、ネットワーク経由で通信するためそのレスポンス、サーバー間のコンテンツ同期が課題となる。

## 05 Webクライアント
Webサーバーとやりとりを行い、Webシステムを利用するためのプログラムをWebクライアントという。<br>
基本的な機能は、Webサーバにリクエストを送信し、サーバーから受け取ったレスポンスを解釈すること。

- Webブラウザ<br>
Webクライアントとして最も広く利用されているのはWbブラウザ。<br>
元々はハイパーテキストの表示のためのプログラムだったが、機能が増えて広く利用される様になった。

- クライアントプログラム<br>
Webブラウザでは利用できないもの、機能を十分に活用できないものに対しては、専用のクライアントプログラムを用意する。<br>
デスクトップアプリやスマホアプリ、専用ブラウザなどがこれに含まれる。

## 06 アプリケーションサーバー
アプリケーションサーバーは、アプリケーション処理の中核となる業務処理を行うサーバー。
Webサーバーから転送されてきた（ユーザーの）データを受け取り、様々な処理をした後（データの加工、DBデータの加工と保存など）<br>
Webサーバーに応答する。

- セッション管理機能<br>
APサーバーは、通信データにセッションIDを含めることで、同じクライアントからの通信を一つのセッションと呼ばれる単位で管理し<br>
ユーザーのログイン状況などを把握する。

- トランザクション管理機能<br>
セッションの中で行われる一連の作業の最小単位をトランザクションと呼ぶ。<br>
作業単位がトランザクションとなる？ログインする、予約（検索〜対象の確認〜対象のステータスを更新〜予約完了）、ログアウト

## 07 データベース管理システム
WebアプリケーションのデータはDBに蓄積される。
このDBを管理するのが、データベース管理システム。<br>
APサーバーからデータの検索や更新の指示を受け、それを実行する。

- 冗長化とデータの同期<br>
Webアプリケーションにとってデータの保全は非常に重要であるため、基本的に冗長化の構成をとる。<br>
構成の種類は主に3つある。<br>
  - ミラーリング<br>
  DBMSが複数のDBに対して同時に更新処理を行う。<br>
  - レプリケーション<br>
  更新指示を受けたDBMSが、更新履歴を別のDBMSに伝える。<br>
  - シェアードディスク<br>
  一つのDBに対し、複数のDBサーバーから更新処理をかけるやり方。<br>
  DB自体は冗長化しないため、耐障害性が高い機器を使用する必要がある。

## 08 キャッシュサーバー
更新が少ない静的コンテンツを表示する場合、毎回DBから取り出すのではなく<br>
キャッシュサーバーに記憶しておくことで、WebサーバーやDBMSの負荷を減らす事ができる。<br>
リクエストに対するレスポンスの記憶をキャッシュという。<br>
文書や画像、動画といったコンテンツのキャッシュをコンテンツキャッシュという。<br>
DBMSの検索要求の結果をクエリキャッシュという。

- キャッシュの有効期限<br>
同一のキャッシュを使い続けると、コンテンツの更新がユーザーに届ける事ができない。<br>
有効期限を定めておく事で自動クリアし、再度キャッシュを取得する。

- CDN(Contents Delivery Network）<br>
CDNは世界中に分散配置されたキャッシュサーバーの集合体。<br>
予めWebサーバーからデータを取得しておき、リクエストから最も近いサーバーが対応する事で、より速いレスポンスを返す事ができる。

## 09 Ajax
- 同期通信<br>
クライアントとサーバーが交互に処理を行い、同調して通信する事を同期通信という。<br>
同期通信は、レスポンス待ちが発生するという課題がある。<br>

- Ajax(Asynchronous javascript + XML)<br>
Ajaxは、同期通信のレスポンス待ちという課題を解決する。<br>
ブラウザ上でJavascriptがサーバーと通信を行い、取得したデータをもとにHTMLを更新する。<br>
データのやり取りにはXMLが用いられ、 JSはDOMを使ってXMLやHTMLを操作する。<br>
更新に必要なデータのみやり取りするため、通信量が少なく、サーバーの負荷も軽減される。<br>
Ajaxでは、JSを使った日同期通信が可能になる。<br>
レスポンスを待つ間、レスポンスに影響されない箇所のHTMLを更新するなど。<br>
→レスポンス待ちが減り、ページの更新が早くなる。<br>

## 10 Webプログラミング
プログラミング言語を使ってWebアプリケーションを開発する事<br>
特徴として、プログラミングの対象がサーバーサイドとクライアントサイドの２種類がある。

- サーバーサイドのプログラミング<br>
クライアントからのリクエストを素早く処理する事が求められるため<br>
効率的な処理（メモリを消費しない）が求められる。<br>
また、DBの扱い（SQL)やセキュリティ面の知識が求められる。

- クライアントサイドのプログラミング<br>
Webアプリケーションにおけるクライアントは、Webブラウザが主に該当する。<br>
複数種類あるブラウザの違いを吸収する（対応する）事が求められる。<br>
近年はAjaxなどの複雑な処理が増えている。

## 11 WebAPI
アプリケーションにおけるクライアントとサーバーのやりとりを、クライアント軽油でなく<br>
プログラムから直接利用する仕組みをWebAPIという。<br>
HTMLなどの文書ではなく、XMLなどの構造化されたデータを扱うため、データの処理はしやすい。

- プログラム同士のデータのやり取り<br>
WebAPIとの通信はいくつか手法があるが、代表的なものは<br>
XML-PRC XMLを送信することで処理の実行を要求するプロトコル<br>
SOAP XML-PRCの機能を拡張したもの。高機能であり、2000年初頭まで利用されたが、最近は利用が減っている。<br>
REST 設計思想であり、SOAPに代わり利用が増えている。

## 12 マッシュアップ
WebAPIを利用し、複数のWebサービスを組み合わせる事で新しいサービスを提供することをマッシュアップという。

- 各サービスの強みを利用する。<br>
一例として、Amazonの商品情報やGoogleの地図情報<br>
自力で調達が困難なデータについて、各社がAPIを公開するようになり、マッシュアップが発展している。

- マッシュアップの注意点<br>
APIの公開は会社の意向が強く反映されるため、仕様変更や公開停止となった場合、APIを利用しているサービスは対応を強いられる。

## 13 CGI
CGIとは、Webサーバーがクライアントからの要求を受け、サーバーサイドスクリプトを起動する仕組み。

- データの渡し方<br>
クライアントがCGIの場所（URL）にアクセスすることで、CGIプログラムが起動する。<br>
このアクセスの際に、クライアントはデータを送信できる。送信方法は3つある。<br>
  - コマンドライン 引数引き渡し<br>
  URLの末尾に？をつけ、その後に＋で区切って値を指定する方法。<br>
  - パス渡し<br>
  CGIの場所を示すURLの後に/をつけてデータを並べ、階層構造を含めて渡す。<br>
  この方法では、データがPASS_INFOという変数に格納される。<br>
  - HTTPのGETメソッド、POSTメソッドを渡す方法<br>
  URLの末尾にデータを付与すると、QUERY_STRINGという変数にデータが格納される。※POSTの場合はデータをURLに含めない。

## 14 サーバー間の連携
CGIを利用せずにクライアントサイドスクリプトを動作させる場合、サーバー間でデータのやりとりを行う。
WebサーバーがAPサーバーに処理を依頼し、APサーバーがサーバーサイドスクリプトを動作させる。
この場合は、処理を依頼する側がクライアント、処理する側がサーバーとなる。

- サーバー同士の通信
サーバー間の通信は、IPアドレスとポート番号を指定し、TCP/IP通信を行う。<br>
サーバーの機器が同一の場合、そのIPアドレスか、自身の機器のIPアドレスを示すアドレスを指定する。<br>

- 利用するプロトコル<br>
APサーバーやDBMSで使用するプロトコルは決まっている。<br>
APサーバーでは、HTTPの他に、AJPやWebsocketsなどが、DBMSでも様々なプロトコルが利用されている。<br>
APサーバーとDBMS間で通信を行うため、ODBC(Open Database Conectivity)というAPIが利用されている。
