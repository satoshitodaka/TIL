# 課題
検索機能を実装する。

## 補足
- 全ての投稿を検索対象とすること（フィードに対する検索ではない）
- 検索条件としては以下の三つとする
  - 本文に検索ワードが含まれている投稿
  - こちらに関しては半角スペースでつなげることでor検索ができるようにする。e.g.「rails ruby」
  - コメントに検索ワードが含まれている投稿
  - 投稿者の名前に検索ワードが含まれている投稿
- ransackなどの検索用のGemは使わず、フォームオブジェクト、ActiveModelを使って実装すること
- 検索時のパスは/posts/searchとすること

## FormObject
### FormObjectとは
- Railsのデザインパターンの一つで、form_with のモデルにActiveRecord以外のオブジェクトを渡すもの。

### Form　Objectのメリット
- DBを使わないフォームでも、ActiveRecordと同じように記述することができる。
- バリデーションなどのロジックをFormObjectに切り出すことで、凝集度を高めることができる。
  - ロジックをコントローラに記述すると、コントローラがモデルの情報を持ちすぎてしまい、肥大化するためNG
  - ロジックをモデルに記述すると、モデルがフォームの情報を持ちすぎてしまうためNG

## ActiveModel::Attributes
クラスに記述することにより、FormObjectで使用する属性と型を指定できる。

[ActiveRecord::Attributes.md](https://github.com/satoshitodaka/TIL/blob/main/06_InstaClone/07_search/ActiveRecord::Attributes.md)

##  SearchFormを作る
- ディレクトリとファイルを作成する
```
mkdir app/forms
touch app/forms/search_posts_forms.rb
```
- 以下のとおり記述する
  - ActiveModel::Modelをincludeする。これは、Formにバリデーションやコールバックなど、モデル的な振る舞いをさせるため。
  - 
```rb
class SearchPostsForm
  include ActiveModel::Model
  include ActiveModel::Attributes

  attribute :body, :string
  attribute :comment_body, :string
  attribute :username, :string

  def search
    scope = Post.distinct
    scope = splited_bodies.map { |splited_body| scope.body_contain(splited_body) }.inject { |result, scp| result.or(scp) } if body.present?
    scope = scope.comment_body_contain(comment_body) if comment_body.present?
    scope = scope.username_contain(username) if username.present?
    scope
  end

  private

    def splited_bodies
      body.strip.split(/[[:blank:]]+/)
    end
end
```
## 検索時のパスを設定する。
- 以下のとおり記載する。
- search アクションはidを持たないので、コレクションルーティングで記載する。
```rb
resources :posts, shallow: true do
  collection do
    get :search
  end
  resources :comments
end
```
# 参考
[Railsのデザインパターン: Formオブジェクト](https://applis.io/posts/rails-design-pattern-form-objects)
[form objectを使ってみよう](https://tech.medpeer.co.jp/entry/2017/05/09/070758)
[ActiveModel::Attributesを使う](https://qiita.com/kazutosato/items/91c5c989f98981d06cd4)
