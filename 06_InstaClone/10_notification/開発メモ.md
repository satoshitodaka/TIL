# 課題
- 通知機能を実装する。
- タイミングと文言は以下の通りとします。（リンク）と書いてある箇所はリンクを付与してください。
  - フォローされたとき
    - xxx（リンク）があなたをフォローしました
    - 通知そのものに対してはxxxへのリンクを張る
  - 自分の投稿にいいねがあったとき
    - xxx（リンク）があなたの投稿（リンク）にいいねしました
    - 通知そのものに対しては投稿へのリンクを張る
  - 自分の投稿にコメントがあったとき
    - xxx（リンク）があなたの投稿（リンク）にコメント（リンク）しました
    - 通知そのものに対してはコメントへのリンクを張る（厳密には投稿ページに遷移し当該コメント部分にページ内ジャンプするイメージ）
- 既読判定も行ってください。通知一覧において、既読のものは薄暗い背景で、未読のものは白い背景で表示しましょう。
- 既読とするタイミングは各通知そのものをクリックした時とします。
- 不自然ではありますが通知の元となったリソースが削除された際には通知自体も削除する仕様とします。

## 補足
- ポリモーフィック関連を使うこと
- ヘッダー部分の通知リストには最新の10件しか表示させないこと

# 開発メモ
## letter_opener_webの導入
### lettter_opener_web とは
- 送信したメールをブラウザ上で確認できる。
- 同様のサービスにletter_openerというものがあるが、これはリモート環境で使用することができない。
- letter_opener_webはリモート接続でも使用することが可能。
### 導入
```rb
# 2.0以上はRuby３が必要とのこと
gem 'letter_opener_web'
```
route.rbに記載
```rb
Rails.application.routes.draw do
  mount LetterOpenerWeb::Engine, at: "/letter_opener" if Rails.env.development?
end
```
この時点で、`http://localhost:3000/letter_opener` にアクセスすると、メールの一覧画面を表示できるようになる。
![Image from Gyazo](https://i.gyazo.com/60216106710fb26338623efa95fc5f13.png)

### 参考
[letter_opener_web](https://github.com/fgrehm/letter_opener_web)

[gem letter_opener を試してみる](https://qiita.com/tanutanu/items/c6193c4c2c352ac152絵c)

## Activityモデルを作る
```
rails g model Activity subject:references user:references action_type:integer read:boolean
```
- 今回はポリモーフィックをマイグレーションファイルに記述したが、`rails g`のコマンドに入れると以下のようになる。
  - `#{関連名}:references{polymorphic}` と書くとマイグレーションファイルにポリモーフィックのオプションが自動で記述される。
```
rails g model Activity subject:references{polymorphic} user:references action_type:integer read:boolean
```
```rb
class CreateActivities < ActiveRecord::Migration[5.2]
  def change
    create_table :activities do |t|
      # ポリモーフィック関連付を記述。今回は手打ちした。
      t.references :subject, polymorphic: true
      t.references :user, foreign_key: true
      t.integer :action_type, null: false
      t.boolean :read, null: false, default: false

      t.timestamps
    end
  end
end
```
### モデルの実装
- 
```rb
# 従属する側
class Activity < ApplicationRecord
  belongs_to :subject, polymorphic: true
end
```
- モヤモヤが未解決。なぜ`has_many`などを指定しなくて良いのか？
```rb
# 従属される側
class Relationship < ApplicationRecord
  after_create_commit :create_activities

  private

    def create_activities
      Activity.create(subject: self, user: followed, action_type: :followed_me)
    end
end

class Like < ApplicationRecord
  after_create_commit :create_activities

  private

    def create_activities
      Activity.create(subject: self, user: post.user, action_type: :liked_to_own_post)
    end
end

class Comment < ApplicationRecord
  after_create_commit :create_activities

  private

  def create_activities
    Activity.create(subject: self, user: post.user, action_type: :commented_to_own_post)
  end
end
```
- UserはActivitiyの一覧を取得する必要があるので、`has_many, belong_to`で紐付けをする。
```rb
class User < ApplicationRecord
  has_many :activities, dependent: :destroy
end
```
```rb
class Activity < ApplicationRecord
  belongs_to :user
end
```
#### ポリモーフィックについて
> [polymorphic.md](https://github.com/satoshitodaka/TIL/blob/main/06_InstaClone/10_notification/polymorphic.md)

#### enum
> [enum.md](https://github.com/satoshitodaka/TIL/blob/main/06_InstaClone/10_notification/enum.md)

## 通知の表示領域のビューを作る。


# 困ったところ
- プルダウンを回答例通り実装したが、プルダウンは動作しなかった。
- TechEssentialや先輩方のアウトプットを確認すると、やはり同様の問題が発生した方は多かった模様。
### 不具合の状況
- ログ上ではエラーらしき表示は確認できなかった。
- ブラウザの開発者ツールを確認すると、以下の表示があった。
![Image from Gyazo](https://i.gyazo.com/bd4510c170b7cd9455f8787f53fa961c.png)

### 試したが改善しなかったもの
- yarnでpopper.jsを導入してみたが改善しなかった。
```
yarn add popper.js
```
- popper_jsのgemを再インストールしたが、効果はなかった。
### 改善につながったもの
- popper.jsをCDNで導入したところ、きちんと動作した。
```html
= stylesheet_link_tag    'application', media: 'all'
= javascript_include_tag 'application'
/ 以下を追記
= javascript_include_tag "https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/umd/popper.min.js"
```
### 参考
[dropdown機能がpopperエラーで機能しない](https://tech-essentials.work/questions/376)
