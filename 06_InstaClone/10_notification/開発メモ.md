# 課題
- 通知機能を実装する。
- タイミングと文言は以下の通りとします。（リンク）と書いてある箇所はリンクを付与してください。
  - フォローされたとき
    - xxx（リンク）があなたをフォローしました
    - 通知そのものに対してはxxxへのリンクを張る
  - 自分の投稿にいいねがあったとき
    - xxx（リンク）があなたの投稿（リンク）にいいねしました
    - 通知そのものに対しては投稿へのリンクを張る
  - 自分の投稿にコメントがあったとき
    - xxx（リンク）があなたの投稿（リンク）にコメント（リンク）しました
    - 通知そのものに対してはコメントへのリンクを張る（厳密には投稿ページに遷移し当該コメント部分にページ内ジャンプするイメージ）
- 既読判定も行ってください。通知一覧において、既読のものは薄暗い背景で、未読のものは白い背景で表示しましょう。
- 既読とするタイミングは各通知そのものをクリックした時とします。
- 不自然ではありますが通知の元となったリソースが削除された際には通知自体も削除する仕様とします。

## 補足
- ポリモーフィック関連を使うこと
- ヘッダー部分の通知リストには最新の10件しか表示させないこと

# 開発メモ
## letter_opener_webの導入
### lettter_opener_web とは
- 送信したメールをブラウザ上で確認できる。
- 同様のサービスにletter_openerというものがあるが、これはリモート環境で使用することができない。
- letter_opener_webはリモート接続でも使用することが可能。
### 導入
```rb
# 2.0以上はRuby３が必要とのこと
gem 'letter_opener_web'
```
route.rbに記載
```rb
Rails.application.routes.draw do
  mount LetterOpenerWeb::Engine, at: "/letter_opener" if Rails.env.development?
end
```
この時点で、`http://localhost:3000/letter_opener` にアクセスすると、メールの一覧画面を表示できるようになる。
![Image from Gyazo](https://i.gyazo.com/60216106710fb26338623efa95fc5f13.png)

### 参考
[letter_opener_web](https://github.com/fgrehm/letter_opener_web)

[gem letter_opener を試してみる](https://qiita.com/tanutanu/items/c6193c4c2c352ac152絵c)

## Activityモデルを作る
```
rails g model Activity subject:references user:references action_type:integer read:boolean
```
- 今回はポリモーフィックをマイグレーションファイルに記述したが、`rails g`のコマンドに入れると以下のようになる。
  - `#{関連名}:references{polymorphic}` と書くとマイグレーションファイルにポリモーフィックのオプションが自動で記述される。
```
rails g model Activity subject:references{polymorphic} user:references action_type:integer read:boolean
```
```rb
class CreateActivities < ActiveRecord::Migration[5.2]
  def change
    create_table :activities do |t|
      # ポリモーフィック関連付を記述。今回は手打ちした。
      t.references :subject, polymorphic: true
      t.references :user, foreign_key: true
      t.integer :action_type, null: false
      t.boolean :read, null: false, default: false

      t.timestamps
    end
  end
end
```
### モデルの実装
- 今回はポリモーフィック関連付を使用することが適切と思われる。
  - 通知モデルは３つのモデル（Comment Like Relationship）に従属している。
  - 関連付のインターフェースを統一し、ポリモーフィック関連付を使うと、関連付をシンプルに記述することができる。

#### ポリモーフィックについて
> [polymorphic.md](https://github.com/satoshitodaka/TIL/blob/main/06_InstaClone/10_notification/polymorphic.md)

```rb
# 従属する側
class Activity < ApplicationRecord
  belongs_to :subject, polymorphic: true
end
```
- モヤモヤが未解決。従属される側ではなぜ`has_many`などを指定しなくて良いのか？
```rb
# 従属される側
class Relationship < ApplicationRecord
  after_create_commit :create_activities

  private

    def create_activities
      Activity.create(subject: self, user: followed, action_type: :followed_me)
    end
end

class Like < ApplicationRecord
  after_create_commit :create_activities

  private

    def create_activities
      Activity.create(subject: self, user: post.user, action_type: :liked_to_own_post)
    end
end

class Comment < ApplicationRecord
  after_create_commit :create_activities

  private

  def create_activities
    Activity.create(subject: self, user: post.user, action_type: :commented_to_own_post)
  end
end
```
- UserはActivitiyの一覧を取得する必要があるので、`has_many, belong_to`で紐付けをする。
```rb
class User < ApplicationRecord
  has_many :activities, dependent: :destroy
end
```
```rb
class Activity < ApplicationRecord
  belongs_to :user
end
```

#### enum
> [enum.md](https://github.com/satoshitodaka/TIL/blob/main/06_InstaClone/10_notification/enum.md)

### 参考
[]()
[]()


## ルーティング
- 以下の通り記述する
```rb
Rails.application.routes.draw do
  # 街頭箇所を抜粋
  resources :activities, only: %i[] do
    patch :read, on: :member
  end

  namespace :mypage do
    resource :account, only: %i[edit update]
    resources :activities, only: %i[index]
  end
end
```
### 通知に関するコントローラを二つ設けることについて
- miketa さんのアウトプットを読んでいてあぁなるほど、と思ったのでメモ
- activityに関するコントローラが２箇所に記述されていて、なぜ一つにまとめないのか？余計なコードを書いていないか、という疑問。（確かに！）
  - RailsはRESTfulな考え方に基づいて設計されており、パスを見ただけで操作の概要を把握できるようにするべきだから。
    - 本来、AcitivityはMypageと無関係であるから、Mypageの下に全てのActivityのアクションを置くのは不適切。
    - 通知の一覧`index`は、Mypageの中でのみ取得するので、Mypageの下以外の場所に置くべきではない。
```rb
namespace :mypage do
  resources :activities, only: %i[index]
end
# 上記のルーティングでは以下のパスとなる
mypage_activities　　　　GET　　　　/mypage/activities(.:format)　　　　mypage/activities#index
```
```rb
resources :activities, only: %i[] do
  patch :read, on: :member
end
# 上記のルーティングでは以下のパスとなる
read_activity PATCH  /activities/:id/read(.:format)  activities#read
```

### ちょっと迷った書き方についてメモ
- なぜ以下の書き方をするのか迷ったので、メモ
  - Activityクラスの`read`アクションを作成するにあたって、リソースフルな書き方をする。
  - `resources :activities` と書くと、通常のCRUDアクションが追加されてしまうので、`only: %i[]`と記述する。
  - `read` アクションはブロックの中に記述する。
```rb
resources :activities, only: %i[] do
  patch :read, on: :member
end
```
### 参考
[Issue 10 ルーティングの設定とパーシャルの重複？について](https://tech-essentials.work/questions/131)

## Activityをコールバックで作成する
- Commentオブジェクト, Likeオブジェクト, Relationshipオブジェクトの作成に連動して作成する必要がある。
- 今回はコールバックの利用が適切とおもわれる。
  - コールバックは、オブジェクトのライフサイクル期間の特定のタイミングに実行されるメソッド。
  - 今回は関連づけられる各モデルのライフサイクルに合わせて実行するものなので、コールバックの使用が適切と言える。
    - コントローラに記述するという選択肢もある。
      - コールバックを多用すると、コードの把握が難しくなるらしい。特にチーム開発では要注意とのこと。
      - コールバックに条件分岐をつけるのは良くない。

### after_create_commitについて
- DBのトランザクションが完了したときにトリガーするコールバックで、`after_commit`のエイリアス
  - `after_save`と似ているが、`after_commit`はDBの変更やロールバックがトリガーとなる点が異なり、DBの一貫性を保てる。
    - `after_commit`を使うようにした方が安全そうな印象を受けた。  
```rb
class Comment < ApplicationRecord
  after_create_commit :create_activities

  private

  def create_activities
    Activity.create(subject: self, user: post.user, action_type: :commented_to_own_post)
  end
end

class Like < ApplicationRecord
  after_create_commit :create_activities

  private

    def create_activities
      Activity.create(subject: self, user: post.user, action_type: :liked_to_own_post)
    end
end

class Relationship < ApplicationRecord
  after_create_commit :create_activities

  private

    def create_activities
      Activity.create(subject: self, user: followed, action_type: :followed_me)
    end
end
```
### 参考
[10 トランザクションのコールバック - Railsガイド](https://railsguides.jp/active_record_callbacks.html#:~:text=%E5%AE%A3%E8%A8%80%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%99%E3%80%82-,10%20%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF,-%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AE%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3)

[苦しめられてやっと理解できたRailsコールバックの使い方](https://tech.kitchhike.com/entry/2018/06/30/232400)

## 通知の表示領域のビューを作る。


# 困ったところ
- プルダウンを回答例通り実装したが、プルダウンは動作しなかった。
- TechEssentialや先輩方のアウトプットを確認すると、やはり同様の問題が発生した方は多かった模様。

### 不具合の状況
- ログ上ではエラーらしき表示は確認できなかった。
- ブラウザの開発者ツールを確認すると、以下の表示があった。
![Image from Gyazo](https://i.gyazo.com/bd4510c170b7cd9455f8787f53fa961c.png)

### 試したが改善しなかったもの
- yarnでpopper.jsを導入してみたが改善しなかった。
```
yarn add popper.js
```
- popper_jsのgemを再インストールしたが、効果はなかった。
### 改善につながったもの
- popper.jsをCDNで導入したところ、きちんと動作した。
```html
= stylesheet_link_tag    'application', media: 'all'
= javascript_include_tag 'application'
/ 以下を追記
= javascript_include_tag "https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/umd/popper.min.js"
```
### 参考
[dropdown機能がpopperエラーで機能しない](https://tech-essentials.work/questions/376)
