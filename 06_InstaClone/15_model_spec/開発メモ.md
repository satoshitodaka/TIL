# 内容
- モデルスペックを実装してください

### 補足
- ユーザーモデルとポストモデルのスペックは最低限書いてください。その他のモデルは任意とします。
- バリデーション, スコープ, インスタンスメソッドのスペックを書いてください。
- 人によっては本実装がサンプルアプリと異なるため、この解答例が絶対的な正解というわけではありません。

# 開発メモ
## Rspecの書き方について
概ね以下の内容でテストを書いていく
```rb
require 'rails_helper'

RSpec.describe User, type: :model do
  describe 'テストする対象' do
    context 'テストをする状況' do
      before do
        事前の準備
      end

      it '仕様の内容' do
        期待する動作
      end
    end
  end
```
#### describe
テストの主題を記述し、何に対してテストするのか？を明示する。一番外側のdescribeにはSpecファイル全体の主題を記述する。（Userのモデルスペックなら`User`など)

#### context
テストの状態・状況を記述する。

#### before
itが実行されるたびに新しく実行される。データの内容も元に戻るため、テストが他のテストに影響しないようになっている。

[![Image from Gyazo](https://i.gyazo.com/113d2faabdf38375680a9258a35e2210.png)](https://gyazo.com/113d2faabdf38375680a9258a35e2210)

### let

## 導入
Gemfileに記述し、インストールする。
```
group :development, :test do
  gem 'factory_bot_rails'
  gem 'rspec-rails'
end
```

ターミナルで実行すると、`spec/rails_helper.rb`と`spec/spec_helper.rb`が生成される。
```
rails g rspec:install
```

FactoryBotの設定を`spec/rails_helper.rb`に追記
```rb
# Prevent database truncation if the environment is production
abort("The Rails environment is running in production mode!") if Rails.env.production?
require 'rspec/rails'
# 下記を追記
require 'factory_bot'

RSpec.configure do |config|
  # 下記を追記
  config.include FactoryBot::Syntax::Methods
end
```

## テストを書く
`rails g rspec:model user`をターミナルで実行

spec/models/user_spec.rbとspec/factories/users.rbが生成される。

spec/factories/users.rbにテストで使用するUserのデータを記述する。
```rb
FactoryBot.define do
  factory :user do
    email { Faker::Internet.unique.email }
    password { 'password' }
    password_confirmation { 'password' }
    username { Faker::Name.name }
  end
end
```

spec/factories/posts.rbにテストで使用するPostのデータを記述する。
```rb
FactoryBot.define do
  factory :post do
    body { Faker::Hacker.say_something_smart }
    images { [File.open("#{Rails.root}/spec/factories/fixture.png")] }
    user
  end
end
```

spec/models/user_spec.rbにテストデータを記述する。
```rb
require 'rails_helper'

RSpec.describe User, type: :model do
  describe 'バリデーション' do
    it 'ユーザー名は必須であること' do
      user = build(:user, username: nil)
      user.valid?
      expect(user.errors[:username]).to include('を入力してください')
    end

    it 'ユーザー名は一意であること' do
      user = create(:user)
      same_name_user = build(:user, username: user.username)
      same_name_user.valid?
      expect(same_name_user.errors[:username]).to include('はすでに存在します')
    end

    it 'メールアドレスは必須であること' do
      user = build(:user, email: nil)
      user.valid?
      expect(user.errors[:email]).to include('を入力してください')
    end

    it 'メールアドレスは一意であること' do
      user = create(:user)
      same_email_user = build(:user, email: user.email)
      same_email_user.valid?
      expect(same_email_user.errors[:email]).to include('はすでに存在します')
    end
  end

  describe 'インスタンスメソッド' do
    let(:user_a) { create(:user) }
    let(:user_b) { create(:user) }
    let(:user_c) { create(:user) }
    let(:post_by_user_a) { create(:post, user: user_a) }
    let(:post_by_user_b) { create(:post, user: user_b) }
    let(:post_by_user_c) { create(:post, user: user_c) }
    describe 'own?' do
      context '自分のオブジェクトの場合' do
        it 'trueを返す' do
          expect(user_a.own?(post_by_user_a)).to be true
        end
      end

      context '自分以外のオブジェクトの場合' do
        it 'falseを返す' do
          expect(user_a.own?(post_by_user_b)).to be false
        end
      end
    end

    describe 'like' do
      it 'いいねできること' do
        expect { user_a.like(post_by_user_b) }.to change { Like.count }.by(1)
      end
    end

    describe 'unlike' do
      it 'いいねを解除できること' do
        user_a.like(post_by_user_b)
        expect { user_a.unlike(post_by_user_b) }.to change { Like.count }.by(-1)
      end
    end

    describe 'follow' do
      it 'フォローできること' do
        expect { user_a.follow(user_b) }.to change { Relationship.count }.by(1)
      end
    end

    describe 'unfollow' do
      it 'フォローを外せること' do
        user_a.follow(user_b)
        expect { user_a.unfollow(user_b) }.to change { Relationship.count }.by(-1)
      end
    end

    describe 'following?' do
      context 'フォローしている場合' do
        it 'trueを返す' do
          user_a.follow(user_b)
          expect(user_a.following?(user_b)).to be true
        end
      end

      context 'フォローしていない場合' do
        it 'falseを返す' do
          expect(user_a.following?(user_b)).to be false
        end
      end
    end

    describe 'feed' do
      before do
        user_a.follow(user_b)
      end
      subject { user_a.feed }
      it { is_expected.to include post_by_user_a }
      it { is_expected.to include post_by_user_b }
      it { is_expected.not_to include post_by_user_c }
    end
  end
end
```

spec/models/post_spec.rbにテストデータを記述する。
```rb
require 'rails_helper'

RSpec.describe Post, type: :model do
  describe 'バリデーション' do
    it '画像は必須であること' do
      post = build(:post, images: nil)
      post.valid?
      expect(post.errors[:images]).to include('を入力してください')
    end

    it '本文は必須であること' do
      post = build(:post, body: nil)
      post.valid?
      expect(post.errors[:body]).to include('を入力してください')
    end

    it '本文は最大1000文字であること' do
      post = build(:post, body: 'a' * 1001)
      post.valid?
      expect(post.errors[:body]).to include('は1000文字以内で入力してください')
    end
  end

  describe 'スコープ' do
    describe 'body_contain' do
      let!(:post) { create(:post, body: 'hello world') }
      subject { Post.body_contain('hello') }
      it { is_expected.to include post }
    end
  end
end
```

### 参考
[Installation - rspec-rails](https://github.com/rspec/rspec-rails#:~:text=Rails%202.x.-,Installation,-IMPORTANT%20This%20README)

[Getting Started - FanctoryBot](https://github.com/thoughtbot/factory_bot/blob/master/GETTING_STARTED.md)

現場Rails

[【Rspec】Factory Botで効率的にテストデータを用意する](https://post-output.com/400-2/)
